{% extends "base.html" %} {% block body %}
<div class="container-fluid mt-4">
  <div class="row">
    <!-- Main Facial Recognition Section -->
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h3 class="mb-0">
            <i class="fas fa-camera me-2"></i>UniSync Card - Live Facial Recognition
          </h3>
          <p class="mb-0 mt-1">Smart Campus Automation - Real-time Attendance System</p>
        </div>
        <div class="card-body p-0">
          <!-- Live Video Feed -->
          <div class="position-relative">
            <img id="videoFeed" src="{{ url_for('video_feed') }}" 
                 class="img-fluid w-100" style="max-height: 500px; object-fit: cover;"
                 alt="Live Facial Recognition Feed"
                 onerror="this.style.display='none'; document.getElementById('videoError').style.display='block';"
                 onload="this.style.display='block'; document.getElementById('videoError').style.display='none';">
            <div id="videoError" style="display: none;" class="text-center p-5">
              <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Video Feed Unavailable</strong><br>
                <small>ESP32-CAM connection may be down. Check connection and try refreshing.</small>
              </div>
            </div>
            <div class="position-absolute top-0 start-0 m-3">
              <div class="bg-dark bg-opacity-75 text-white p-2 rounded">
                <small><i class="fas fa-circle text-success me-1"></i>LIVE</small>
              </div>
            </div>
          </div>
          
          <!-- Recognition Status Bar -->
          <div class="status-bar p-3 border-top">
            <div class="row align-items-center">
              <div class="col-md-4">
                <strong>Current Person:</strong> 
                <span id="currentPerson" class="badge bg-secondary fs-6">Waiting...</span>
              </div>
              <div class="col-md-4">
                <strong>Faces Trained:</strong> 
                <span id="facesTrained" class="badge bg-info fs-6">0</span>
              </div>
              <div class="col-md-4">
                <strong>ESP32-CAM Status:</strong> 
                <span id="esp32Status" class="badge bg-secondary fs-6">Checking...</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Facial Recognition Controls -->
      <div class="row mt-3">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Recognition Controls</h5>
            </div>
            <div class="card-body">
              <div class="row g-2">
                <div class="col-12 col-sm-6 col-lg-12 d-grid">
                  <button id="trainFacesBtn" class="btn btn-primary">
                    <i class="fas fa-brain"></i>Train All Faces
                  </button>
                </div>
                <div class="col-12 col-sm-6 col-lg-12 d-grid">
                  <button id="testEsp32Btn" class="btn btn-info">
                    <i class="fas fa-wifi"></i>Test ESP32-CAM Connection
                  </button>
                </div>
                <div class="col-12 col-sm-6 col-lg-12 d-grid">
                  <button id="refreshStatusBtn" class="btn btn-primary">
                    <i class="fas fa-sync"></i>Refresh Status
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Today's Attendance</h5>
            </div>
            <div class="card-body">
              <div id="todayAttendance">
                <p class="text-muted">Loading attendance data...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar - User Management -->
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header bg-secondary text-white">
          <h5 class="mb-0"><i class="fas fa-users me-2"></i>User Management</h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2 mb-3">
            <a href="{{ url_for('create_user') }}" class="btn btn-primary">
              <i class="fas fa-user-plus me-2"></i>Create New User
            </a>
            <a href="{{ url_for('mark_attendance') }}" class="btn btn-outline-secondary">
              <i class="fas fa-edit me-2"></i>Manual Attendance (Backup)
            </a>
            <a href="{{ url_for('admin_streaming_settings') }}" class="btn btn-outline-info">
              <i class="fas fa-cog me-2"></i>Streaming Settings
            </a>
            <a href="{{ url_for('admin_holidays') }}" class="btn btn-outline-warning">
              <i class="fas fa-calendar-day me-2"></i>Manage Holidays
            </a>
          </div>
          
          <div class="card bg-light">
            <div class="card-body">
              <h6 class="card-title">System Overview</h6>
              <p class="card-text mb-1">
                <strong>Total Users:</strong> {{ users|length }}
              </p>
              <p class="card-text mb-1">
                <strong>Students:</strong> {{ users|selectattr('role', 'equalto', 'student')|list|length }}
              </p>
              <p class="card-text mb-1">
                <strong>Teachers:</strong> {{ users|selectattr('role', 'equalto', 'teacher')|list|length }}
              </p>
              <p class="card-text">
                <strong>Admins:</strong> {{ users|selectattr('role', 'equalto', 'admin')|list|length }}
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick User Actions -->
      <div class="card mt-3">
        <div class="card-header">
          <h6 class="mb-0"><i class="fas fa-user-cog me-2"></i>Quick Actions</h6>
        </div>
        <div class="card-body">
          <div class="list-group list-group-flush">
            {% for user in users[:5] %}
            <div class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <strong>{{ user.username }}</strong>
                <br><small class="text-muted">{{ user.role|title }}</small>
              </div>
              <div class="btn-group btn-group-sm">
                <a href="{{ url_for('admin_manage_images', username=user.username) }}" 
                   class="btn btn-outline-primary btn-sm" title="Manage Images">
                  <i class="fas fa-camera"></i>
                </a>
                <a href="{{ url_for('edit_user', user_id=user.id) }}" 
                   class="btn btn-outline-secondary btn-sm" title="Edit User">
                  <i class="fas fa-edit"></i>
                </a>
                <button onclick="confirmDelete({{ user.id }}, '{{ user.username }}')" 
                        class="btn btn-outline-danger btn-sm" title="Delete User">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
            {% endfor %}
            {% if users|length > 5 %}
            <div class="list-group-item text-center">
              <small class="text-muted">+{{ users|length - 5 }} more users</small>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete user <strong id="deleteUserName"></strong>?</p>
        <p class="text-danger"><small>This action cannot be undone.</small></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="deleteForm" method="POST" style="display: inline">
          <button type="submit" class="btn btn-danger">Delete User</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
// Facial Recognition Status Updates
function updateRecognitionStatus() {
  fetch('/get_recognition_status')
    .then(response => response.json())
    .then(data => {
      document.getElementById('currentPerson').textContent = data.current_person || 'Waiting...';
      document.getElementById('facesTrained').textContent = data.total_faces_trained || '0';
      
      // Update status colors
      const currentPersonEl = document.getElementById('currentPerson');
      if (data.current_person && data.current_person !== 'Waiting...' && data.current_person !== 'Unknown') {
        currentPersonEl.className = 'badge bg-success fs-6';
      } else {
        currentPersonEl.className = 'badge bg-secondary fs-6';
      }
    })
    .catch(error => console.error('Error updating status:', error));
}

// Test ESP32-CAM Connection
document.getElementById('testEsp32Btn').addEventListener('click', function() {
  this.disabled = true;
  this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing...';
  
  fetch('/test_esp32_connection')
    .then(response => response.json())
    .then(data => {
      const statusEl = document.getElementById('esp32Status');
      if (data.success) {
        statusEl.textContent = 'Connected';
        statusEl.className = 'badge bg-success';
      } else {
        statusEl.textContent = 'Disconnected';
        statusEl.className = 'badge bg-danger';
      }
    })
    .catch(error => {
      document.getElementById('esp32Status').textContent = 'Error';
      document.getElementById('esp32Status').className = 'badge bg-danger';
    })
    .finally(() => {
      this.disabled = false;
      this.innerHTML = '<i class="fas fa-wifi me-2"></i>Test ESP32-CAM Connection';
    });
});

// Train Faces
document.getElementById('trainFacesBtn').addEventListener('click', function() {
  this.disabled = true;
  this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Training...';
  
  fetch('/train_faces')
    .then(response => {
      if (response.ok) {
        alert('Faces trained successfully!');
        updateRecognitionStatus();
      } else {
        alert('Error training faces');
      }
    })
    .catch(error => {
      alert('Error training faces: ' + error);
    })
    .finally(() => {
      this.disabled = false;
      this.innerHTML = '<i class="fas fa-brain me-2"></i>Train All Faces';
    });
});

// Refresh Status
document.getElementById('refreshStatusBtn').addEventListener('click', function() {
  updateRecognitionStatus();
  this.innerHTML = '<i class="fas fa-check me-2"></i>Refreshed';
  setTimeout(() => {
    this.innerHTML = '<i class="fas fa-sync me-2"></i>Refresh Status';
  }, 1000);
});

// Global variables for attendance tracking
let lastAttendanceCheck = '';
let currentAttendanceData = [];

// Load today's attendance data
function loadTodayAttendance() {
    fetch('/get_today_attendance')
        .then(response => response.json())
        .then(data => {
            const attendanceDiv = document.getElementById('todayAttendance');
            if (data.today_attendance && data.today_attendance.length > 0) {
                // Deduplicate records by user, keeping the latest timestamp for each user
                const uniqueUsers = new Map();
                data.today_attendance.forEach(record => {
                    const existing = uniqueUsers.get(record.user_name);
                    if (!existing || new Date(record.timestamp) > new Date(existing.timestamp)) {
                        uniqueUsers.set(record.user_name, record);
                    }
                });
                
                // Convert to array and sort by timestamp (newest first)
                currentAttendanceData = Array.from(uniqueUsers.values())
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                let html = `<div class="mb-2"><strong>Total Present: ${currentAttendanceData.length}</strong></div>`;
                html += '<div class="list-group list-group-flush">';
                currentAttendanceData.forEach(record => {
                    const time = new Date(record.timestamp).toLocaleTimeString();
                    html += `<div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${record.user_name}</strong>
                            <br><small class="text-muted">${time}</small>
                        </div>
                        <span class="badge bg-success">Present</span>
                    </div>`;
                });
                html += '</div>';
                attendanceDiv.innerHTML = html;
            } else {
                currentAttendanceData = [];
                attendanceDiv.innerHTML = '<p class="text-muted">No attendance recorded today</p>';
            }
        })
        .catch(error => {
            console.error('Error loading attendance:', error);
            document.getElementById('todayAttendance').innerHTML = 
                '<p class="text-danger">Error loading attendance data</p>';
        });
}

// Check for new attendance records
function checkNewAttendance() {
    fetch(`/check_new_attendance?last_check=${lastAttendanceCheck}`)
        .then(response => response.json())
        .then(data => {
            if (data.has_new_records && data.new_attendance.length > 0) {
                console.log('New attendance detected:', data.new_attendance);
                
                // Create a map to track unique users and their latest timestamp
                const uniqueUsers = new Map();
                
                // First, add existing records to the map
                currentAttendanceData.forEach(record => {
                    uniqueUsers.set(record.user_name, record);
                });
                
                // Then add new records, keeping only the latest timestamp for each user
                data.new_attendance.forEach(record => {
                    const existing = uniqueUsers.get(record.user_name);
                    if (!existing || new Date(record.timestamp) > new Date(existing.timestamp)) {
                        uniqueUsers.set(record.user_name, record);
                    }
                });
                
                // Convert map back to array and sort by timestamp (newest first)
                currentAttendanceData = Array.from(uniqueUsers.values())
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Update the display immediately
                const attendanceDiv = document.getElementById('todayAttendance');
                let html = `<div class="mb-2"><strong>Total Present: ${currentAttendanceData.length}</strong></div>`;
                html += '<div class="list-group list-group-flush">';
                currentAttendanceData.forEach(record => {
                    const time = new Date(record.timestamp).toLocaleTimeString();
                    html += `<div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${record.user_name}</strong>
                            <br><small class="text-muted">${time}</small>
                        </div>
                        <span class="badge bg-success">Present</span>
                    </div>`;
                });
                html += '</div>';
                attendanceDiv.innerHTML = html;
                
                // Show notification for new attendance (only for truly new users)
                const newUsers = data.new_attendance.filter(record => {
                    const existing = uniqueUsers.get(record.user_name);
                    return !existing || new Date(record.timestamp) > new Date(existing.timestamp);
                });
                if (newUsers.length > 0) {
                    showAttendanceNotification(newUsers);
                }
            }
            
            // Update last check time
            lastAttendanceCheck = data.current_time;
        })
        .catch(error => {
            console.error('Error checking new attendance:', error);
        });
}

// Show notification for new attendance
function showAttendanceNotification(newRecords) {
    newRecords.forEach(record => {
        const time = new Date(record.timestamp).toLocaleTimeString();
        
        // Create notification element
        const notification = document.createElement('div');
        notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            <i class="fas fa-user-check me-2"></i>
            <strong>${record.user_name}</strong> marked present at ${time}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Add to page
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    });
}

// Auto-update status every 2 seconds
setInterval(updateRecognitionStatus, 2000);

// Check for new attendance every 1 second for real-time updates
setInterval(checkNewAttendance, 1000);

// Load full attendance data every 30 seconds as backup
setInterval(loadTodayAttendance, 30000);

// Initial status update
updateRecognitionStatus();
loadTodayAttendance();

// Delete user function
function confirmDelete(userId, username) {
  document.getElementById("deleteUserName").textContent = username;
  document.getElementById("deleteForm").action = "{{ url_for('delete_user', user_id=0) }}".replace("0", userId);
  const modal = new bootstrap.Modal(document.getElementById("deleteModal"));
  modal.show();
}

// Handle delete form submission
document.getElementById("deleteForm").addEventListener("submit", function(e) {
  e.preventDefault();
  
  const form = this;
  const submitBtn = form.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerHTML;
  
  // Show loading state
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Deleting...';
  
  console.log('Deleting user from:', form.action);
  
  // Submit the form
  fetch(form.action, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: new FormData(form)
  })
  .then(response => {
    console.log('Delete response status:', response.status);
    if (response.ok) {
      // Close modal and refresh page to show updated user list
      const modal = bootstrap.Modal.getInstance(document.getElementById("deleteModal"));
      modal.hide();
      console.log('User deleted successfully, refreshing page...');
      // Force a hard refresh to clear any cache
      window.location.href = window.location.href;
    } else {
      throw new Error(`Delete failed with status: ${response.status}`);
    }
  })
  .catch(error => {
    console.error('Error deleting user:', error);
    alert('Error deleting user. Please try again.');
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalText;
  });
});
</script>
{% endblock %}
