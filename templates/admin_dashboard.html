{% extends "base.html" %} 

{% block title %}Admin Dashboard - UniSync{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb" class="container mt-3">
  <ol class="breadcrumb">
    <li class="breadcrumb-item">
      <a href="{{ url_for('index') }}" class="text-decoration-none">
        <i class="fas fa-home me-1"></i>Home
      </a>
    </li>
    <li class="breadcrumb-item active" aria-current="page">
      <i class="fas fa-tachometer-alt me-1"></i>Admin Dashboard
    </li>
  </ol>
</nav>
{% endblock %}

{% block body %}
<div class="container-fluid mt-4">
  <div class="row">
    <!-- Main Facial Recognition Section -->
    <div class="col-lg-8">
      <div class="card border-0 elev-3">
        <div class="card-header bg-primary text-white">
          <h3 class="mb-0">
            <i class="fas fa-camera me-2"></i>UniSync Card - Live Facial Recognition
          </h3>
          <p class="mb-0 mt-1">Smart Campus Automation - Real-time Attendance System</p>
        </div>
        <div class="card-body p-0">
          <!-- Live Video Feed -->
          <div class="position-relative">
            <img id="videoFeed" src="{{ url_for('video_feed') }}" 
                 class="img-fluid w-100" style="max-height: 500px; object-fit: cover;"
                 alt="Live Facial Recognition Feed"
                 onerror="this.style.display='none'; document.getElementById('videoError').style.display='block';"
                 onload="this.style.display='block'; document.getElementById('videoError').style.display='none';">
            <div id="videoError" style="display: none;" class="text-center p-5">
              <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Video Feed Unavailable</strong><br>
                <small>ESP32-CAM connection may be down. Check connection and try refreshing.</small>
              </div>
            </div>
            <div class="position-absolute top-0 start-0 m-3">
              <div class="bg-dark bg-opacity-75 text-white p-2 rounded">
                <small><i class="fas fa-circle text-success me-1"></i>LIVE</small>
              </div>
            </div>
          </div>
          
          <!-- Recognition Status Bar -->
          <div class="status-bar p-3 border-top">
            <div class="row align-items-center">
              <div class="col-md-4">
                <strong>Current Person:</strong> 
                <span id="currentPerson" class="badge bg-secondary fs-6">Waiting...</span>
              </div>
              <div class="col-md-4">
                <strong>Faces Trained:</strong> 
                <span id="facesTrained" class="badge bg-info fs-6">0</span>
              </div>
              <div class="col-md-4">
                <strong>ESP32-CAM Status:</strong> 
                <span id="esp32Status" class="badge bg-secondary fs-6">Checking...</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Facial Recognition Controls -->
      <div class="row mt-3">
        <div class="col-md-6">
          <div class="card border-0 elev-2">
            <div class="card-header">
              <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Recognition Controls</h5>
            </div>
            <div class="card-body">
              <div class="row g-2">
                <div class="col-12 col-sm-6 col-lg-12 d-grid">
                  <button id="trainFacesBtn" class="btn btn-primary">
                    <i class="fas fa-brain"></i>Train All Faces
                  </button>
                </div>
                <div class="col-12 col-sm-6 col-lg-12 d-grid">
                  <button id="testEsp32Btn" class="btn btn-info">
                    <i class="fas fa-wifi"></i>Test ESP32-CAM Connection
                  </button>
                </div>
                <div class="col-12 col-sm-6 col-lg-12 d-grid">
                  <button id="refreshStatusBtn" class="btn btn-primary">
                    <i class="fas fa-sync"></i>Refresh Status
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-md-6">
          <div class="card border-0 elev-2">
            <div class="card-header">
              <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Today's Attendance</h5>
            </div>
            <div class="card-body">
              <div id="todayAttendance">
                <p class="text-muted">Loading attendance data...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar - Quick Actions -->
    <div class="col-lg-4">
      <div class="card border-0 elev-3">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-tools me-2"></i>Quick Actions</h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2 mb-3">
            <a href="{{ url_for('admin_user_management') }}" class="btn btn-primary">
              <i class="fas fa-users me-2"></i>User Management
            </a>
            <a href="{{ url_for('create_user') }}" class="btn btn-success">
              <i class="fas fa-user-plus me-2"></i>Create New User
            </a>
            <a href="{{ url_for('mark_attendance') }}" class="btn btn-outline-secondary">
              <i class="fas fa-edit me-2"></i>Manual Attendance (Backup)
            </a>
            <a href="{{ url_for('admin_streaming_settings') }}" class="btn btn-outline-info">
              <i class="fas fa-cog me-2"></i>Streaming Settings
            </a>
            <a href="{{ url_for('admin_rfid') }}" class="btn btn-outline-success">
              <i class="fas fa-id-card me-2"></i>RFID Management
            </a>
            <a href="{{ url_for('admin_holidays') }}" class="btn btn-outline-warning">
              <i class="fas fa-calendar-day me-2"></i>Manage Holidays
            </a>
          </div>
          
          <div class="card bg-light">
            <div class="card-body">
              <h6 class="card-title">System Overview</h6>
              <p class="card-text mb-1">
                <strong>Total Users:</strong> {{ users|length }}
              </p>
              <p class="card-text mb-1">
                <strong>Students:</strong> {{ users|selectattr('role', 'equalto', 'student')|list|length }}
              </p>
              <p class="card-text mb-1">
                <strong>Teachers:</strong> {{ users|selectattr('role', 'equalto', 'teacher')|list|length }}
              </p>
              <p class="card-text">
                <strong>Admins:</strong> {{ users|selectattr('role', 'equalto', 'admin')|list|length }}
              </p>
            </div>
          </div>
        </div>
      </div>



      <!-- Enhanced User Records Access -->
      <div class="card mt-3 border-0 elev-2">
        <div class="card-header">
          <h6 class="mb-0"><i class="fas fa-database me-2"></i>User Records Access</h6>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label for="userSelect" class="form-label">Select User:</label>
            <select class="form-select" id="userSelect">
              <option value="">Choose a user...</option>
              {% for user in users %}
              <option value="{{ user.id }}">{{ user.username }} ({{ user.role|title }})</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="d-grid gap-2">
            <button id="viewRecordsBtn" class="btn btn-outline-primary btn-sm" disabled>
              <i class="fas fa-eye me-2"></i>View Attendance Records
            </button>
            <button id="exportRecordsBtn" class="btn btn-outline-success btn-sm" disabled>
              <i class="fas fa-download me-2"></i>Export Records
            </button>
            <button id="modifyRecordsBtn" class="btn btn-outline-warning btn-sm" disabled>
              <i class="fas fa-edit me-2"></i>Modify Records
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced User Records Section -->
  <div class="row mt-4" id="userRecordsSection" style="display: none;">
    <div class="col-12">
      <div class="card border-0 elev-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="fas fa-user-clock me-2"></i>
            Attendance Records for <span id="selectedUserName"></span>
          </h5>
          <div>
            <button id="refreshRecordsBtn" class="btn btn-outline-primary btn-sm">
              <i class="fas fa-sync me-2"></i>Refresh
            </button>
            <button id="closeRecordsBtn" class="btn btn-outline-secondary btn-sm">
              <i class="fas fa-times me-2"></i>Close
            </button>
          </div>
        </div>
        <div class="card-body">
          <div id="userRecordsContent">
            <p class="text-muted">Loading user records...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete user <strong id="deleteUserName"></strong>?</p>
        <p class="text-danger"><small>This action cannot be undone.</small></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="deleteForm" method="POST" style="display: inline">
          <button type="submit" class="btn btn-danger">Delete User</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- User Records Modal -->
<div class="modal fade" id="userRecordsModal" tabindex="-1" aria-labelledby="userRecordsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="userRecordsModalLabel">User Attendance Records</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="modalRecordsContent">
          <!-- Records will be loaded here -->
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="exportModalRecords">Export</button>
      </div>
    </div>
  </div>
</div>

<script>
// Enhanced User Management
let selectedUserId = null;
let selectedUserName = '';

// User selection handler
document.getElementById('userSelect').addEventListener('change', function() {
  const userId = this.value;
  const buttons = ['viewRecordsBtn', 'exportRecordsBtn', 'modifyRecordsBtn'];
  
  if (userId) {
    selectedUserId = userId;
    selectedUserName = this.options[this.selectedIndex].text;
    buttons.forEach(btnId => {
      document.getElementById(btnId).disabled = false;
    });
  } else {
    selectedUserId = null;
    selectedUserName = '';
    buttons.forEach(btnId => {
      document.getElementById(btnId).disabled = true;
    });
    document.getElementById('userRecordsSection').style.display = 'none';
  }
});

// View Records Button
document.getElementById('viewRecordsBtn').addEventListener('click', function() {
  if (selectedUserId) {
    loadUserRecords(selectedUserId);
    document.getElementById('userRecordsSection').style.display = 'block';
    document.getElementById('selectedUserName').textContent = selectedUserName;
  }
});

// Export Records Button
document.getElementById('exportRecordsBtn').addEventListener('click', function() {
  if (selectedUserId) {
    exportUserRecords(selectedUserId);
  }
});

// Modify Records Button
document.getElementById('modifyRecordsBtn').addEventListener('click', function() {
  if (selectedUserId) {
    showModifyRecordsModal(selectedUserId);
  }
});

// Refresh Records Button
document.getElementById('refreshRecordsBtn').addEventListener('click', function() {
  if (selectedUserId) {
    loadUserRecords(selectedUserId);
  }
});

// Close Records Button
document.getElementById('closeRecordsBtn').addEventListener('click', function() {
  document.getElementById('userRecordsSection').style.display = 'none';
});

// Load user records
function loadUserRecords(userId) {
  const contentDiv = document.getElementById('userRecordsContent');
  contentDiv.innerHTML = '<p class="text-muted">Loading user records...</p>';
  
  fetch(`/admin/get_user_records/${userId}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        displayUserRecords(data.records, data.user_info);
      } else {
        contentDiv.innerHTML = `<p class="text-danger">Error: ${data.message}</p>`;
      }
    })
    .catch(error => {
      console.error('Error loading user records:', error);
      contentDiv.innerHTML = '<p class="text-danger">Error loading user records</p>';
    });
}

// Display user records
function displayUserRecords(records, userInfo) {
  const contentDiv = document.getElementById('userRecordsContent');
  
  let html = `
    <div class="row mb-3">
      <div class="col-md-6">
        <h6>User Information</h6>
        <p><strong>Username:</strong> ${userInfo.username}</p>
        <p><strong>Role:</strong> ${userInfo.role}</p>
        <p><strong>Total Records:</strong> ${records.length}</p>
      </div>
      <div class="col-md-6">
        <h6>Quick Actions</h6>

      </div>
    </div>
  `;
  
  if (records.length > 0) {
    html += `
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Date</th>
              <th>Time</th>
              <th>Type</th>
              <th>Method</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
    `;
    
    records.forEach(record => {
      const date = new Date(record.timestamp).toLocaleDateString();
      const time = new Date(record.timestamp).toLocaleTimeString();
      
      html += `
        <tr>
          <td>${date}</td>
          <td>${time}</td>
          <td>
            <span class="badge bg-success">Present</span>
          </td>
          <td>${record.method || 'Facial Recognition'}</td>
          <td>

            <button class="btn btn-outline-danger btn-sm" onclick="deleteRecord(${record.id})">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      `;
    });
    
    html += `
          </tbody>
        </table>
      </div>
    `;
  } else {
    html += '<p class="text-muted">No attendance records found for this user.</p>';
  }
  
  contentDiv.innerHTML = html;
}

// Export user records
function exportUserRecords(userId) {
  fetch(`/admin/export_user_records/${userId}`)
    .then(response => response.blob())
    .then(blob => {
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `user_records_${userId}.csv`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    })
    .catch(error => {
      console.error('Error exporting records:', error);
      alert('Error exporting records');
    });
}



// Delete individual record
function deleteRecord(recordId) {
  if (confirm('Are you sure you want to delete this record?')) {
    fetch(`/admin/delete_record/${recordId}`, {
      method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Refresh the records display
        if (selectedUserId) {
          loadUserRecords(selectedUserId);
        }
      } else {
        alert('Error deleting record: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error deleting record:', error);
      alert('Error deleting record');
    });
  }
}

// Facial Recognition Status Updates
function updateRecognitionStatus() {
  fetch('/get_recognition_status')
    .then(response => response.json())
    .then(data => {
      document.getElementById('currentPerson').textContent = data.current_person || 'Waiting...';
      document.getElementById('facesTrained').textContent = data.total_faces_trained || '0';
      
      // Update status colors
      const currentPersonEl = document.getElementById('currentPerson');
      if (data.current_person && data.current_person !== 'Waiting...' && data.current_person !== 'Unknown') {
        currentPersonEl.className = 'badge bg-success fs-6';
      } else {
        currentPersonEl.className = 'badge bg-secondary fs-6';
      }
    })
    .catch(error => console.error('Error updating status:', error));
}

// Test ESP32-CAM Connection
document.getElementById('testEsp32Btn').addEventListener('click', function() {
  this.disabled = true;
  this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing...';
  
  fetch('/test_esp32_connection')
    .then(response => response.json())
    .then(data => {
      const statusEl = document.getElementById('esp32Status');
      if (data.success) {
        statusEl.textContent = 'Connected';
        statusEl.className = 'badge bg-success';
      } else {
        statusEl.textContent = 'Disconnected';
        statusEl.className = 'badge bg-danger';
      }
    })
    .catch(error => {
      document.getElementById('esp32Status').textContent = 'Error';
      document.getElementById('esp32Status').className = 'badge bg-danger';
    })
    .finally(() => {
      this.disabled = false;
      this.innerHTML = '<i class="fas fa-wifi me-2"></i>Test ESP32-CAM Connection';
    });
});

// Train Faces
document.getElementById('trainFacesBtn').addEventListener('click', function() {
  this.disabled = true;
  this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Training...';
  
  fetch('/train_faces')
    .then(response => {
      if (response.ok) {
        alert('Faces trained successfully!');
        updateRecognitionStatus();
      } else {
        alert('Error training faces');
      }
    })
    .catch(error => {
      alert('Error training faces: ' + error);
    })
    .finally(() => {
      this.disabled = false;
      this.innerHTML = '<i class="fas fa-brain me-2"></i>Train All Faces';
    });
});

// Refresh Status
document.getElementById('refreshStatusBtn').addEventListener('click', function() {
  updateRecognitionStatus();
  this.innerHTML = '<i class="fas fa-check me-2"></i>Refreshed';
  setTimeout(() => {
    this.innerHTML = '<i class="fas fa-sync me-2"></i>Refresh Status';
  }, 1000);
});

// Global variables for attendance tracking
let lastAttendanceCheck = '';
let currentAttendanceData = [];

// Load today's attendance data
function loadTodayAttendance() {
    fetch('/get_today_attendance')
        .then(response => response.json())
        .then(data => {
            const attendanceDiv = document.getElementById('todayAttendance');
            if (data.today_attendance && data.today_attendance.length > 0) {
                // Deduplicate records by user, keeping the latest timestamp for each user
                const uniqueUsers = new Map();
                data.today_attendance.forEach(record => {
                    const existing = uniqueUsers.get(record.user_name);
                    if (!existing || new Date(record.timestamp) > new Date(existing.timestamp)) {
                        uniqueUsers.set(record.user_name, record);
                    }
                });
                
                // Convert to array and sort by timestamp (newest first)
                currentAttendanceData = Array.from(uniqueUsers.values())
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                let html = `<div class="mb-2"><strong>Total Present: ${currentAttendanceData.length}</strong></div>`;
                html += '<div class="list-group list-group-flush">';
                currentAttendanceData.forEach(record => {
                    const time = new Date(record.timestamp).toLocaleTimeString();
                    html += `<div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${record.user_name}</strong>
                            <br><small class="text-muted">${time}</small>
                        </div>
                        <span class="badge bg-success">Present</span>
                    </div>`;
                });
                html += '</div>';
                attendanceDiv.innerHTML = html;
            } else {
                currentAttendanceData = [];
                attendanceDiv.innerHTML = '<p class="text-muted">No attendance recorded today</p>';
            }
        })
        .catch(error => {
            console.error('Error loading attendance:', error);
            document.getElementById('todayAttendance').innerHTML = 
                '<p class="text-danger">Error loading attendance data</p>';
        });
}

// Check for new attendance records
function checkNewAttendance() {
    fetch(`/check_new_attendance?last_check=${lastAttendanceCheck}`)
        .then(response => response.json())
        .then(data => {
            if (data.has_new_records && data.new_attendance.length > 0) {
                console.log('New attendance detected:', data.new_attendance);
                
                // Create a map to track unique users and their latest timestamp
                const uniqueUsers = new Map();
                
                // First, add existing records to the map
                currentAttendanceData.forEach(record => {
                    uniqueUsers.set(record.user_name, record);
                });
                
                // Then add new records, keeping only the latest timestamp for each user
                data.new_attendance.forEach(record => {
                    const existing = uniqueUsers.get(record.user_name);
                    if (!existing || new Date(record.timestamp) > new Date(existing.timestamp)) {
                        uniqueUsers.set(record.user_name, record);
                    }
                });
                
                // Convert map back to array and sort by timestamp (newest first)
                currentAttendanceData = Array.from(uniqueUsers.values())
                    .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Update the display immediately
                const attendanceDiv = document.getElementById('todayAttendance');
                let html = `<div class="mb-2"><strong>Total Present: ${currentAttendanceData.length}</strong></div>`;
                html += '<div class="list-group list-group-flush">';
                currentAttendanceData.forEach(record => {
                    const time = new Date(record.timestamp).toLocaleTimeString();
                    html += `<div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${record.user_name}</strong>
                            <br><small class="text-muted">${time}</small>
                        </div>
                        <span class="badge bg-success">Present</span>
                    </div>`;
                });
                html += '</div>';
                attendanceDiv.innerHTML = html;
                
                // Show notification for new attendance (only for truly new users)
                const newUsers = data.new_attendance.filter(record => {
                    const existing = uniqueUsers.get(record.user_name);
                    return !existing || new Date(record.timestamp) > new Date(existing.timestamp);
                });
                if (newUsers.length > 0) {
                    showAttendanceNotification(newUsers);
                }
            }
            
            // Update last check time
            lastAttendanceCheck = data.current_time;
        })
        .catch(error => {
            console.error('Error checking new attendance:', error);
        });
}

// Show notification for new attendance
function showAttendanceNotification(newRecords) {
    newRecords.forEach(record => {
        const time = new Date(record.timestamp).toLocaleTimeString();
        
        // Create notification element
        const notification = document.createElement('div');
        notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            <i class="fas fa-user-check me-2"></i>
            <strong>${record.user_name}</strong> marked present at ${time}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Add to page
        document.body.appendChild(notification);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    });
}

// Auto-update status every 2 seconds
setInterval(updateRecognitionStatus, 2000);

// Check for new attendance every 1 second for real-time updates
setInterval(checkNewAttendance, 1000);

// Load full attendance data every 30 seconds as backup
setInterval(loadTodayAttendance, 30000);

// Initial status update
updateRecognitionStatus();
loadTodayAttendance();


</script>
{% endblock %}
