<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />

    <title>ESP32-CAM Facial Recognition</title>
  </head>
  <body>
    <div class="container mt-4">
      <div class="row">
        <div class="col-12">
          <h1 class="text-center mb-4">ESP32-CAM Facial Recognition System</h1>
          
          <!-- Status Information -->
          <div class="row mb-4">
            <div class="col-md-6">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title">
                    <i class="fas fa-info-circle me-2"></i>System Status
                  </h5>
                  <p class="card-text">
                    <strong>Current Person:</strong> <span id="current-person">Waiting...</span><br>
                    <strong>Faces Trained:</strong> <span id="faces-trained">-</span><br>
                    <strong>ESP32-CAM:</strong> <span id="esp32-status">Checking...</span>
                  </p>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title">
                    <i class="fas fa-cogs me-2"></i>Controls
                  </h5>
                  <div class="btn-group-vertical w-100">
                    <a href="{{ url_for('train_faces') }}" class="btn btn-primary mb-2 w-100">
                      <i class="fas fa-brain me-2"></i>Train All Faces
                    </a>
                    <button id="test-esp32" class="btn btn-info mb-2 w-100">
                      <i class="fas fa-wifi me-2"></i>Test ESP32-CAM Connection
                    </button>
                    <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary w-100">
                      <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Video Feed -->
          <div class="card">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-video me-2"></i>Live ESP32-CAM Feed
              </h5>
            </div>
            <div class="card-body text-center">
              <img id="video-feed" src="{{ url_for('video_feed') }}" 
                   class="img-fluid" style="max-width: 100%; height: auto;"
                   alt="ESP32-CAM Stream">
              <div class="mt-3">
                <small class="text-muted">
                  <i class="fas fa-info-circle me-1"></i>
                  Real-time facial recognition from ESP32-CAM at {{ config.ESP32_IP }}
                </small>
              </div>
            </div>
          </div>

          <!-- Recognition Log -->
          <div class="card mt-4">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="fas fa-list me-2"></i>Recognition Log
              </h5>
            </div>
            <div class="card-body">
              <div id="recognition-log" class="text-muted">
                <i class="fas fa-clock me-2"></i>Waiting for recognition events...
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>

    <!-- Font Awesome -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

    <script>
      // Update status periodically
      function updateStatus() {
        fetch('/get_recognition_status')
          .then(response => response.json())
          .then(data => {
            document.getElementById('current-person').textContent = data.current_person || 'Unknown';
            document.getElementById('faces-trained').textContent = data.total_faces_trained || '0';
          })
          .catch(error => {
            console.error('Error updating status:', error);
          });
      }

      // Test ESP32-CAM connection
      document.getElementById('test-esp32').addEventListener('click', function() {
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Testing...';
        
        fetch('/test_esp32_connection')
          .then(response => response.json())
          .then(data => {
            console.log('ESP32-CAM Test Results:', data);
            
            let statusText = 'Unknown';
            let statusClass = 'text-muted';
            
            if (data.success) {
              statusText = 'Connected';
              statusClass = 'text-success';
            } else {
              statusText = 'Connection Failed';
              statusClass = 'text-danger';
            }
            
            document.getElementById('esp32-status').textContent = statusText;
            document.getElementById('esp32-status').className = statusClass;
            
            // Show alert with details
            let message = `ESP32-CAM Connection Test:\n\n`;
            message += `IP: ${data.esp32_ip}\n`;
            message += `URL: ${data.stream_url}\n`;
            message += `Status: ${data.success ? 'Connected' : 'Failed'}\n`;
            if (data.error) {
              message += `Error: ${data.error}`;
            }
            
            alert(message);
          })
          .catch(error => {
            console.error('Error testing ESP32-CAM:', error);
            document.getElementById('esp32-status').textContent = 'Test Failed';
            document.getElementById('esp32-status').className = 'text-danger';
            alert('Error testing ESP32-CAM connection');
          })
          .finally(() => {
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-wifi me-2"></i>Test ESP32-CAM Connection';
          });
      });

      // Update status every 2 seconds
      setInterval(updateStatus, 2000);
      
      // Initial status check
      updateStatus();
    </script>
  </body>
</html> 